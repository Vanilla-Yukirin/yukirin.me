name: Deploy to Server

on:
  push:
    branches:
      - main  # 只有推送到 main 分支时才触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Next.js App via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22000
          script: |
            # 1. 进入项目目录
            cd /var/www/yukirin.me 

            # 2. 获取远程最新代码
            git fetch --all

            # 3. 强制重置本地代码到远程的 main 分支（解决冲突）
            git reset --hard origin/main
            
            # 4. 安装依赖（使用 ci 而不是 install，因为这是 CI/CD 环境）
            npm ci

            # 5. 构建 Next.js 应用（生成 .next 目录）
            npm run build

            # 6. 重启应用（使用 PM2）
            pm2 restart yukirin-site

            # 7. 保存进程列表
            pm2 save

            echo "✅ Next.js 部署成功！"