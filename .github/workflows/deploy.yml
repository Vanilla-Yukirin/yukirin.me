name: Deploy to Server

on:
  push:
    branches:
      - main  # åªæœ‰æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Next.js App via SSH
        uses: appleboy/ssh-action@v1.0.3
        # æ³¨å…¥ SILICONFLOW ç¯å¢ƒå˜é‡
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          SILICONFLOW_BASE_URL: ${{ secrets.SILICONFLOW_BASE_URL }}
          SHENGSUAN_API_KEY: ${{ secrets.SHENGSUAN_API_KEY }}
          SHENGSUAN_BASE_URL: ${{ secrets.SHENGSUAN_BASE_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # é€šè¿‡ssh-actionä¼ ç¯å¢ƒå˜é‡
          envs: SILICONFLOW_API_KEY,SILICONFLOW_BASE_URL
          port: 22000
          script: |
            # -1. è®¾ç½®è„šæœ¬å‡ºé”™å³é€€å‡º
            set -e

            echo "ğŸš€ å¼€å§‹éƒ¨ç½² Next.js åº”ç”¨..."

            # 0. åŒæ­¥æ—¶é—´ï¼ˆGitHub Actions æ—¶é—´å‡†ç¡®ï¼Œé¿å… NTP ä¸å¯ç”¨é—®é¢˜ï¼‰
            # è·å–å½“å‰ UTC æ—¶é—´ï¼Œè½¬æ¢ä¸º CST å¹¶è®¾ç½®åˆ°æœåŠ¡å™¨
            # export SYNC_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            # echo "â° ä» GitHub Actions åŒæ­¥æ—¶é—´: $SYNC_TIME"
            # sudo date -s "$SYNC_TIME"
            # sudo hwclock --systohc --utc
            # echo "âœ… æ—¶é—´åŒæ­¥å®Œæˆ"
            echo "âœ… ä¸è¿›è¡Œæ—¶é—´åŒæ­¥"

            # 1. è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/yukirin.me

            # 2. è·å–è¿œç¨‹æœ€æ–°ä»£ç 
            git fetch --all

            # 3. å¼ºåˆ¶é‡ç½®æœ¬åœ°ä»£ç åˆ°è¿œç¨‹çš„ main åˆ†æ”¯ï¼ˆè§£å†³å†²çªï¼‰
            git reset --hard origin/main
            
            # 3.5 æ³¨å…¥å½“å‰æäº¤ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡ï¼ˆæ„å»ºæ—¶å¯ç”¨ï¼‰
            # export NEXT_PUBLIC_COMMIT_SHA=$(git rev-parse --short HEAD)
            # export NEXT_PUBLIC_COMMIT_URL="https://github.com/Vanilla-Yukirin/yukirin.me/commit/${NEXT_PUBLIC_COMMIT_SHA}"
            # export NEXT_TELEMETRY_DISABLED=1

            # 4. å°†ç¯å¢ƒå˜é‡å†™å…¥ .env.production æ–‡ä»¶
            echo "ğŸ“ æ­£åœ¨ç”Ÿæˆ .env.production..."
            echo "# Auto-generated file. Do not edit." > .env.production
            # SILCONFLOW
            echo "SILICONFLOW_API_KEY=$SILICONFLOW_API_KEY" >> .env.production
            echo "SILICONFLOW_BASE_URL=$SILICONFLOW_BASE_URL" >> .env.production
            # SHENGSUAN
            echo "SHENGSUAN_API_KEY=$SHENGSUAN_API_KEY" >> .env.production
            echo "SHENGSUAN_BASE_URL=$SHENGSUAN_BASE_URL" >> .env.production
            # Git Commit Info
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "NEXT_PUBLIC_COMMIT_SHA=$COMMIT_SHA" >> .env.production
            echo "NEXT_PUBLIC_COMMIT_URL=https://github.com/Vanilla-Yukirin/yukirin.me/commit/$COMMIT_SHA" >> .env.production
            # Disable Telemetry
            echo "NEXT_TELEMETRY_DISABLED=1" >> .env.production

            chmod 600 .env.production
            echo "âœ… .env.production å†™å…¥å®Œæˆ"

            # 5. å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci

            # 6. æ„å»º Next.js åº”ç”¨ï¼ˆç”Ÿæˆ .next ç›®å½•ï¼‰
            echo "ğŸ—ï¸ å¼€å§‹æ„å»º..."
            npm run build

            # 7. å°è¯• reloadï¼Œå¤±è´¥åˆ™ start
            pm2 reload yukirin-site --update-env || pm2 start ecosystem.config.js

            # 8. ä¿å­˜è¿›ç¨‹åˆ—è¡¨
            pm2 save

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼Current Commit: $COMMIT_SHA"