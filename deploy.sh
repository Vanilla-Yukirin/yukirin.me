#!/bin/bash
# Next.js + PM2 + Nginx å¿«é€Ÿéƒ¨ç½²è„šæœ¬
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œæ­¤è„šæœ¬æ¥å¿«é€Ÿéƒ¨ç½²æˆ–æ›´æ–°åº”ç”¨

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸš€ å¼€å§‹éƒ¨ç½² yukirin.me (Next.js)..."

# é…ç½®
PROJECT_DIR="/var/www/yukirin.me"
NODE_ENV="production"

# ============================================
# ç¬¬ä¸€æ¬¡éƒ¨ç½²æ—¶è¿è¡Œï¼ˆåˆå§‹åŒ–ï¼‰
# ============================================

# å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œéœ€è¦ï¼š
# 1. å®‰è£… Node.js å’Œ npm
# 2. å®‰è£… Nginx
# 3. å®‰è£… PM2ï¼šsudo npm install -g pm2
# 4. å…‹éš†é¡¹ç›®ï¼šcd /var/www && git clone ...

# ============================================
# æ›´æ–°ä»£ç 
# ============================================

cd "$PROJECT_DIR"

echo "ğŸ“¥ æ›´æ–°ä»£ç ..."
git fetch --all
git reset --hard origin/main

# æ³¨å…¥å½“å‰æ„å»ºçš„ Git æäº¤ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡ï¼ˆä¾› Next.js ä½¿ç”¨ï¼‰
# ä½¿ç”¨ NEXT_PUBLIC_ å‰ç¼€ä»¥ä¾¿åœ¨å®¢æˆ·ç«¯æ¸²æŸ“å¯ç”¨
COMMIT_SHA=$(git rev-parse --short HEAD)
export NEXT_PUBLIC_COMMIT_SHA="$COMMIT_SHA"
export NEXT_PUBLIC_COMMIT_URL="https://github.com/Vanilla-Yukirin/yukirin.me/commit/$COMMIT_SHA"
# å¯é€‰ï¼šå…³é—­ Next.js é¥æµ‹
export NEXT_TELEMETRY_DISABLED=1

# ============================================
# å®‰è£…ä¾èµ–
# ============================================

echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm ci  # ç”¨ ci è€Œä¸æ˜¯ installï¼Œå› ä¸ºè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒ

# ============================================
# æ„å»ºåº”ç”¨
# ============================================

echo "ğŸ”¨ æ„å»º Next.js åº”ç”¨..."
npm run build

# ============================================
# å¯åŠ¨æˆ–é‡å¯ PM2
# ============================================

echo "ğŸ”„ å¯åŠ¨/é‡å¯åº”ç”¨..."

# æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¿è¡Œçš„è¿›ç¨‹
if pm2 list | grep -q "yukirin-site"; then
  echo "åº”ç”¨å·²è¿è¡Œï¼Œæ­£åœ¨é‡å¯..."
  pm2 restart yukirin-site
else
  echo "é¦–æ¬¡å¯åŠ¨åº”ç”¨..."
  pm2 start ecosystem.config.js
fi

# ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save

# ============================================
# éªŒè¯
# ============================================

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo ""
echo "æ£€æŸ¥åº”ç”¨çŠ¶æ€ï¼š"
pm2 status
echo ""
echo "æŸ¥çœ‹æ—¥å¿—ï¼š"
echo "  pm2 logs yukirin-site"
echo ""
echo "æŸ¥çœ‹å®æ—¶ç›‘æ§ï¼š"
echo "  pm2 monit"
